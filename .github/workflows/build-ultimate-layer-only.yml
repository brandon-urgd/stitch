name: Build Ultimate Badass Lambda Layer (Manual)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to build layer for (dev, staging, prod)'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - staging
        - prod
      force_rebuild:
        description: 'Force rebuild even if layer exists'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  id-token: write

jobs:
  build-ultimate-layer:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # Give it time to build the beast
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION || 'us-west-2' }}

    - name: Install system dependencies (NUCLEAR OPTION)
      run: |
        echo "ğŸš€ Installing system dependencies for ultimate layer..."
        sudo apt-get update
        sudo apt-get install -y \
          libjpeg-dev \
          libpng-dev \
          libtiff-dev \
          libwebp-dev \
          libopenjp2-7-dev \
          libopenjp2-7 \
          libopencv-dev \
          libopencv-contrib-dev \
          libopenblas-dev \
          liblapack-dev \
          libatlas-base-dev \
          libgfortran5 \
          gfortran \
          libhdf5-dev \
          libhdf5-serial-dev \
          libprotobuf-dev \
          protobuf-compiler \
          libcairo2-dev \
          libpango1.0-dev \
          libgdk-pixbuf2.0-dev \
          libglib2.0-dev \
          libffi-dev \
          libssl-dev \
          libbz2-dev \
          liblzma-dev \
          libreadline-dev \
          libsqlite3-dev \
          libncurses5-dev \
          build-essential \
          cmake \
          pkg-config \
          libxml2-dev \
          libxslt1-dev \
          libfreetype6-dev \
          libfontconfig1-dev \
          libx11-dev \
          libxext-dev \
          libxrender-dev \
          tcl-dev \
          tk-dev

    - name: Build Image Processing Layer
      run: |
        echo "ğŸ”¥ Building Image Processing Layer..."
        
        # Create build directory
        mkdir -p image-layer-build
        cd image-layer-build
        
        # Copy requirements
        cp ../layers/image-processing/requirements.txt .
        
        # Install Python dependencies
        pip install --upgrade pip setuptools wheel
        echo "âš¡ Installing image processing dependencies..."
        pip install -r requirements.txt -t ./python/ --no-cache-dir
        
        # Create the layer zip
        echo "ğŸ’¥ Creating image processing layer package..."
        zip -r image-processing.zip python/
        
        # Get the size
        LAYER_SIZE=$(du -h image-processing.zip | cut -f1)
        echo "ğŸ¯ IMAGE PROCESSING LAYER BUILT! Size: $LAYER_SIZE"
        
        # Upload to S3
        aws s3 cp image-processing.zip s3://urgd-applicationdata/stitch/layers/image-processing.zip --region us-west-2
        
        echo "ğŸš€ IMAGE PROCESSING LAYER DEPLOYED TO S3!"

    - name: Build Scientific Computing Layer
      run: |
        echo "ğŸ”¥ Building Scientific Computing Layer..."
        
        # Create build directory
        mkdir -p scientific-layer-build
        cd scientific-layer-build
        
        # Copy requirements
        cp ../layers/scientific-computing/requirements.txt .
        
        # Install Python dependencies
        pip install --upgrade pip setuptools wheel
        echo "âš¡ Installing scientific computing dependencies..."
        pip install -r requirements.txt -t ./python/ --no-cache-dir
        
        # Create the layer zip
        echo "ğŸ’¥ Creating scientific computing layer package..."
        zip -r scientific-computing.zip python/
        
        # Get the size
        LAYER_SIZE=$(du -h scientific-computing.zip | cut -f1)
        echo "ğŸ¯ SCIENTIFIC COMPUTING LAYER BUILT! Size: $LAYER_SIZE"
        
        # Upload to S3
        aws s3 cp scientific-computing.zip s3://urgd-applicationdata/stitch/layers/scientific-computing.zip --region us-west-2
        
        echo "ğŸš€ SCIENTIFIC COMPUTING LAYER DEPLOYED TO S3!"

    - name: Publish Image Processing Layer
      run: |
        # Create Image Processing layer
        IMAGE_LAYER_ARN=$(aws lambda publish-layer-version \
          --layer-name urgd-image-processing-${{ github.event.inputs.environment }} \
          --description "Image processing and SVG tools - ${{ github.event.inputs.environment }}" \
          --content S3Bucket=urgd-applicationdata,S3Key=stitch/layers/image-processing.zip \
          --compatible-runtimes python3.12 \
          --compatible-architectures x86_64 \
          --query 'LayerVersionArn' \
          --output text \
          --region us-west-2)
        
        echo "ğŸ¯ Image Processing Layer ARN: $IMAGE_LAYER_ARN"
        echo "IMAGE_LAYER_ARN=$IMAGE_LAYER_ARN" >> $GITHUB_ENV

    - name: Publish Scientific Computing Layer
      run: |
        # Create Scientific Computing layer
        SCIENTIFIC_LAYER_ARN=$(aws lambda publish-layer-version \
          --layer-name urgd-scientific-computing-${{ github.event.inputs.environment }} \
          --description "Scientific computing and ML tools - ${{ github.event.inputs.environment }}" \
          --content S3Bucket=urgd-applicationdata,S3Key=stitch/layers/scientific-computing.zip \
          --compatible-runtimes python3.12 \
          --compatible-architectures x86_64 \
          --query 'LayerVersionArn' \
          --output text \
          --region us-west-2)
        
        echo "ğŸ¯ Scientific Computing Layer ARN: $SCIENTIFIC_LAYER_ARN"
        echo "SCIENTIFIC_LAYER_ARN=$SCIENTIFIC_LAYER_ARN" >> $GITHUB_ENV

    - name: Output Layer Info
      run: |
        echo "ğŸš€ BOTH LAMBDA LAYERS DEPLOYED!"
        echo "ğŸ’ª Image Processing Layer ARN: $IMAGE_LAYER_ARN"
        echo "ğŸ’ª Scientific Computing Layer ARN: $SCIENTIFIC_LAYER_ARN"
        echo "ğŸ”¥ Ready to power your Lambda functions!"
        echo "âš¡ Split into focused layers for maximum efficiency!"
        echo ""
        echo "ğŸ“ To use these layers in your Lambda functions:"
        echo "   Layers:"
        echo "     - $IMAGE_LAYER_ARN"
        echo "     - $SCIENTIFIC_LAYER_ARN"
