name: Deploy Stitch with CloudFormation

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION || 'us-west-2' }}
        
    - name: Install dependencies
      run: |
        cd lambda
        pip install -r requirements.txt
        
    - name: Create Lambda layer
      run: |
        mkdir -p layer/python
        cd lambda
        pip install -r requirements.txt -t ../layer/python/
        cd ../layer
        zip -r ../layer.zip .
        
    - name: Create Lambda deployment package
      run: |
        cd lambda
        zip -r ../lambda_function.zip .
        
    - name: Upload artifacts to S3
      run: |
        # Upload Lambda function code to urgd-applicationdata bucket
        aws s3 cp lambda_function.zip s3://urgd-applicationdata/stitch/lambda/stitch-function.zip
        
        # Upload Lambda layer to urgd-applicationdata bucket
        aws s3 cp layer.zip s3://urgd-applicationdata/stitch/layers/stitch-libs.zip
        
        # Upload website files to urgd-applicationdata bucket
        aws s3 cp website/ s3://urgd-applicationdata/stitch/website/ --recursive
        
    - name: Deploy CloudFormation Stack
      run: |
        chmod +x scripts/deploy-cloudformation.sh
        ./scripts/deploy-cloudformation.sh
        
    - name: Upload website to S3
      run: |
        # Get the website bucket name from CloudFormation outputs
        WEBSITE_BUCKET=$(aws cloudformation describe-stacks \
          --stack-name urgd-stitch-infrastructure \
          --query 'Stacks[0].Outputs[?OutputKey==`WebsiteUrl`].OutputValue' \
          --output text | sed 's|https://||' | sed 's|.s3-website.*||')
        
        echo "Uploading website to bucket: $WEBSITE_BUCKET"
        
        # Upload website files to the S3 website bucket
        aws s3 cp website/ s3://$WEBSITE_BUCKET/ --recursive
        
        echo "Website uploaded successfully!"
        
    - name: Get CloudFront Distribution ID
      id: cloudfront
      run: |
        STACK_NAME="urgd-stitch-infrastructure"
        REGION="${{ secrets.AWS_REGION || 'us-west-2' }}"
        
        CLOUDFRONT_ID=$(aws cloudformation describe-stacks \
          --stack-name "$STACK_NAME" \
          --region "$REGION" \
          --query 'Stacks[0].Outputs[?OutputKey==`CloudFrontDistributionId`].OutputValue' \
          --output text)
        
        if [ "$CLOUDFRONT_ID" = "None" ] || [ -z "$CLOUDFRONT_ID" ]; then
          echo "‚ÑπÔ∏è  No CloudFront distribution found in stack outputs"
          echo "CLOUDFRONT_ID=" >> $GITHUB_OUTPUT
        else
          echo "‚úÖ CloudFront Distribution ID: $CLOUDFRONT_ID"
          echo "CLOUDFRONT_ID=$CLOUDFRONT_ID" >> $GITHUB_OUTPUT
        fi
        
    - name: Configure AWS credentials (us-east-1)
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1
        
    - name: Associate WAF with CloudFront
      id: waf
      if: steps.cloudfront.outputs.CLOUDFRONT_ID != ''
      run: |
        CLOUDFRONT_ID="${{ steps.cloudfront.outputs.CLOUDFRONT_ID }}"
        
        echo "üîó Associating WAF with CloudFront..."
        
        # Use prod WAF since we're not doing separate environments
        WAF_SSM_PARAM="/urgd/waf/prod/web_acl_arn"
        
        WAF_ARN=$(aws ssm get-parameter \
          --name "$WAF_SSM_PARAM" \
          --query 'Parameter.Value' \
          --output text \
          --region us-east-1)
        
        if [ "$WAF_ARN" = "None" ] || [ -z "$WAF_ARN" ]; then
          echo "‚ùå WAF ARN not found in SSM parameter: $WAF_SSM_PARAM"
          exit 1
        fi
        
        echo "‚úÖ WAF ARN: $WAF_ARN"
        echo "WAF_ARN=$WAF_ARN" >> $GITHUB_OUTPUT
        echo "‚úÖ CloudFront Distribution ID: $CLOUDFRONT_ID"
        
        # Get AWS Account ID
        AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text --region us-east-1)
        echo "‚úÖ AWS Account ID: $AWS_ACCOUNT_ID"
        
        # Get the current distribution configuration
        echo "üìã Getting current distribution configuration..."
        aws cloudfront get-distribution-config \
          --id "$CLOUDFRONT_ID" \
          --region us-east-1 > /tmp/distribution-response.json
        
        ETAG=$(jq -r '.ETag' /tmp/distribution-response.json)
        echo "‚úÖ ETag: $ETAG"
        
        # Extract the distribution config
        jq '.DistributionConfig' /tmp/distribution-response.json > /tmp/distribution-config.json
        
        # Add WAF to the distribution configuration
        echo "üîß Adding WAF to distribution configuration..."
        jq --arg webacl "$WAF_ARN" '.WebACLId = $webacl' /tmp/distribution-config.json > /tmp/distribution-config-updated.json
        
        # Update the CloudFront distribution
        echo "üöÄ Updating CloudFront distribution with WAF..."
        aws cloudfront update-distribution \
          --id "$CLOUDFRONT_ID" \
          --distribution-config file:///tmp/distribution-config-updated.json \
          --if-match "$ETAG" \
          --region us-east-1
        
        echo "‚úÖ WAF successfully associated with CloudFront distribution"
        
    - name: Get deployment URLs
      run: |
        STACK_NAME="urgd-stitch-infrastructure"
        REGION="${{ secrets.AWS_REGION || 'us-west-2' }}"
        CLOUDFRONT_ID="${{ steps.cloudfront.outputs.CLOUDFRONT_ID }}"
        WAF_ARN="${{ steps.waf.outputs.WAF_ARN }}"
        
        echo "üéâ Deployment Summary"
        echo "==================="
        echo "Stack Name: $STACK_NAME"
        echo "Region: $REGION"
        echo "CloudFront Distribution ID: $CLOUDFRONT_ID"
        echo "WAF ARN: $WAF_ARN"
        echo "Deployed by: $GITHUB_ACTOR"
        echo "Workflow run: $GITHUB_RUN_ID"
        echo "Commit: $GITHUB_SHA"
        echo ""
        echo "===================="
        
        # Get Function URL
        FUNCTION_URL=$(aws cloudformation describe-stacks \
          --stack-name "$STACK_NAME" \
          --region "$REGION" \
          --query 'Stacks[0].Outputs[?OutputKey==`FunctionUrl`].OutputValue' \
          --output text)
        echo "üîó Function URL: $FUNCTION_URL"
        
        # Get CloudFront URL
        CLOUDFRONT_URL=$(aws cloudformation describe-stacks \
          --stack-name "$STACK_NAME" \
          --region "$REGION" \
          --query 'Stacks[0].Outputs[?OutputKey==`CloudFrontUrl`].OutputValue' \
          --output text)
        
        if [ "$CLOUDFRONT_URL" != "None" ] && [ -n "$CLOUDFRONT_URL" ]; then
          echo "‚òÅÔ∏è  CloudFront URL: $CLOUDFRONT_URL"
        fi
        
        # Get Custom Domain URL
        CUSTOM_DOMAIN=$(aws cloudformation describe-stacks \
          --stack-name "$STACK_NAME" \
          --region "$REGION" \
          --query 'Stacks[0].Outputs[?OutputKey==`CustomDomainUrl`].OutputValue' \
          --output text)
        
        if [ "$CUSTOM_DOMAIN" != "None" ] && [ -n "$CUSTOM_DOMAIN" ]; then
          echo "üåê Custom Domain: $CUSTOM_DOMAIN"
          echo "::notice::Stitch is deployed! Access it at: $CUSTOM_DOMAIN"
        else
          echo "::notice::Stitch is deployed! Access it at: $FUNCTION_URL"
        fi
