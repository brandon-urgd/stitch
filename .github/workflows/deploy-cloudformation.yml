name: Deploy Stitch with CloudFormation

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION || 'us-west-2' }}
        
    - name: Prepare website files
      run: |
        echo "üìÅ Website files ready for upload to S3 bucket"
        
    - name: Build Lambda package
      run: |
        echo "üî® Building Lambda package..."
        cd lambda
        pip install -r requirements.txt -t .
        zip -r ../lambda-package.zip .
        cd ..
        echo "‚úÖ Lambda package built: lambda-package.zip"
        
    - name: Upload artifacts to S3
      run: |
        # Get current git commit hash
        GIT_COMMIT=$(git rev-parse --short HEAD)
        echo "üì¶ Git commit: $GIT_COMMIT"
        
        # Upload Lambda package to artifacts folder
        aws s3 cp lambda-package.zip s3://urgd-applicationdata/stitch/artifacts/lambda-prod-${GIT_COMMIT}.zip
        echo "‚úÖ Lambda package uploaded to S3 artifacts folder"
        
        # Upload CloudFormation template to cloudformation folder
        aws s3 cp cloudformation/stitch-infrastructure.yaml s3://urgd-applicationdata/stitch/cloudformation/stitch-infrastructure.yaml
        echo "‚úÖ CloudFormation template uploaded to S3 cloudformation folder"
        
    - name: Deploy CloudFormation Stack
      run: |
        chmod +x scripts/deploy-cloudformation.sh
        ./scripts/deploy-cloudformation.sh
        
    - name: Upload website to S3
      run: |
        # Get the website bucket name directly from the stack
        WEBSITE_BUCKET=$(aws cloudformation describe-stacks \
          --stack-name urgd-stitch-infrastructure \
          --query 'Stacks[0].Outputs[?OutputKey==`WebsiteBucketName`].OutputValue' \
          --output text)
        
        # Get the API Gateway URL from the stack and append /api path
        API_BASE_URL=$(aws cloudformation describe-stacks \
          --stack-name urgd-stitch-infrastructure \
          --query 'Stacks[0].Outputs[?OutputKey==`ApiUrl`].OutputValue' \
          --output text)
        API_URL="${API_BASE_URL}/api"
        
        echo "Uploading website to bucket: $WEBSITE_BUCKET"
        echo "API Gateway URL: $API_URL"
        
        # Create a temporary directory for the website with injected API URL
        mkdir -p temp-website
        cp -r website/* temp-website/
        
        # Replace the API URL placeholder in the HTML file
        sed -i "s|API_GATEWAY_URL_PLACEHOLDER|$API_URL|g" temp-website/index.html
        
        # Upload website files to the S3 website bucket
        aws s3 cp temp-website/ s3://$WEBSITE_BUCKET/ --recursive
        
        # Clean up
        rm -rf temp-website/
        
        echo "Website uploaded successfully with dynamic API URL!"
        
    - name: Get CloudFront Distribution ID
      id: cloudfront
      run: |
        STACK_NAME="urgd-stitch-infrastructure"
        REGION="${{ secrets.AWS_REGION || 'us-west-2' }}"
        
        CLOUDFRONT_ID=$(aws cloudformation describe-stacks \
          --stack-name "$STACK_NAME" \
          --region "$REGION" \
          --query 'Stacks[0].Outputs[?OutputKey==`CloudFrontDistributionId`].OutputValue' \
          --output text)
        
        if [ "$CLOUDFRONT_ID" = "None" ] || [ -z "$CLOUDFRONT_ID" ]; then
          echo "‚ÑπÔ∏è  No CloudFront distribution found in stack outputs"
          echo "CLOUDFRONT_ID=" >> $GITHUB_OUTPUT
        else
          echo "‚úÖ CloudFront Distribution ID: $CLOUDFRONT_ID"
          echo "CLOUDFRONT_ID=$CLOUDFRONT_ID" >> $GITHUB_OUTPUT
        fi
        
    - name: Configure AWS credentials (us-east-1)
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1
        
    - name: Associate WAF with CloudFront
      id: waf
      if: steps.cloudfront.outputs.CLOUDFRONT_ID != ''
      run: |
        CLOUDFRONT_ID="${{ steps.cloudfront.outputs.CLOUDFRONT_ID }}"
        
        echo "üîó Associating WAF with CloudFront..."
        
        # Use prod WAF since we're not doing separate environments
        WAF_SSM_PARAM="/urgd/waf/prod/web_acl_arn"
        
        WAF_ARN=$(aws ssm get-parameter \
          --name "$WAF_SSM_PARAM" \
          --query 'Parameter.Value' \
          --output text \
          --region us-east-1)
        
        if [ "$WAF_ARN" = "None" ] || [ -z "$WAF_ARN" ]; then
          echo "‚ùå WAF ARN not found in SSM parameter: $WAF_SSM_PARAM"
          exit 1
        fi
        
        echo "‚úÖ WAF ARN: $WAF_ARN"
        echo "WAF_ARN=$WAF_ARN" >> $GITHUB_OUTPUT
        echo "‚úÖ CloudFront Distribution ID: $CLOUDFRONT_ID"
        
        # Get AWS Account ID
        AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text --region us-east-1)
        echo "‚úÖ AWS Account ID: $AWS_ACCOUNT_ID"
        
        # Get the current distribution configuration
        echo "üìã Getting current distribution configuration..."
        aws cloudfront get-distribution-config \
          --id "$CLOUDFRONT_ID" \
          --region us-east-1 > /tmp/distribution-response.json
        
        ETAG=$(jq -r '.ETag' /tmp/distribution-response.json)
        echo "‚úÖ ETag: $ETAG"
        
        # Extract the distribution config
        jq '.DistributionConfig' /tmp/distribution-response.json > /tmp/distribution-config.json
        
        # Add WAF to the distribution configuration
        echo "üîß Adding WAF to distribution configuration..."
        jq --arg webacl "$WAF_ARN" '.WebACLId = $webacl' /tmp/distribution-config.json > /tmp/distribution-config-updated.json
        
        # Update the CloudFront distribution
        echo "üöÄ Updating CloudFront distribution with WAF..."
        aws cloudfront update-distribution \
          --id "$CLOUDFRONT_ID" \
          --distribution-config file:///tmp/distribution-config-updated.json \
          --if-match "$ETAG" \
          --region us-east-1
        
        echo "‚úÖ WAF successfully associated with CloudFront distribution"
        
    - name: Get deployment URLs
      run: |
        STACK_NAME="urgd-stitch-infrastructure"
        REGION="${{ secrets.AWS_REGION || 'us-west-2' }}"
        CLOUDFRONT_ID="${{ steps.cloudfront.outputs.CLOUDFRONT_ID }}"
        WAF_ARN="${{ steps.waf.outputs.WAF_ARN }}"
        
        echo "üéâ Deployment Summary"
        echo "==================="
        echo "Stack Name: $STACK_NAME"
        echo "Region: $REGION"
        echo "CloudFront Distribution ID: $CLOUDFRONT_ID"
        echo "WAF ARN: $WAF_ARN"
        echo "Deployed by: $GITHUB_ACTOR"
        echo "Workflow run: $GITHUB_RUN_ID"
        echo "Commit: $GITHUB_SHA"
        echo ""
        echo "===================="
        
        # Get API Gateway URL
        API_URL=$(aws cloudformation describe-stacks \
          --stack-name "$STACK_NAME" \
          --region "$REGION" \
          --query 'Stacks[0].Outputs[?OutputKey==`ApiUrl`].OutputValue' \
          --output text)
        echo "üîó API Gateway URL: $API_URL"
        
        # Get CloudFront URL
        CLOUDFRONT_URL=$(aws cloudformation describe-stacks \
          --stack-name "$STACK_NAME" \
          --region "$REGION" \
          --query 'Stacks[0].Outputs[?OutputKey==`CloudFrontUrl`].OutputValue' \
          --output text)
        
        if [ "$CLOUDFRONT_URL" != "None" ] && [ -n "$CLOUDFRONT_URL" ]; then
          echo "‚òÅÔ∏è  CloudFront URL: $CLOUDFRONT_URL"
          echo "::notice::Stitch is deployed! Access it at: $CLOUDFRONT_URL"
        else
          echo "::notice::Stitch is deployed! Access it at: $API_URL"
        fi
